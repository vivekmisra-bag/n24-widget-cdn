/**
 * News24 Audio Widget - Core Engine
 * (c) 2026 News24 Content Tech. All Rights Reserved.
 * Unauthorized use or reverse engineering is prohibited.
 */

(function() {
    // 1. SECURITY: DOMAIN LOCKING
    // Only these domains are allowed to load the widget.
    const ALLOWED_DOMAINS = [
        'news24online.com',
        'localhost',          // For your testing
        'hindi-news24online-com-preprod.go-vip.net',
        'news24online-com-develop.go-vip.net'   // Future clients
    ];

    const currentDomain = window.location.hostname;
    const isAllowed = ALLOWED_DOMAINS.some(d => currentDomain.includes(d));

    if (!isAllowed) {
        console.warn('News24 Audio Widget: Access Denied for ' + currentDomain);
        return; // STOP EXECUTION IMMEDIATELY
    }

    console.log('News24 Tech: Audio Widget Initializing...');

    // 2. CONFIGURATION (Can be overridden by the embed tag)
    const scriptTag = document.currentScript || document.querySelector('script[src*="n24-audio-widget"]');
    const TARGET_SELECTOR = scriptTag.getAttribute('data-target') || '#article-body';
    const WIDGET_LANG = scriptTag.getAttribute('data-lang') || 'hi-IN';

    // 3. INJECT STYLES (The CSS is now hidden inside JS)
    const styleCSS = `
        #n24-audio-wrapper {
            width: 100%; margin: 20px 0; font-family: 'Segoe UI', Roboto, sans-serif;
            position: -webkit-sticky; position: sticky; top: 0; z-index: 999;
            transition: top 0.3s ease; opacity: 0; animation: fadeIn 0.5s forwards;
        }
        @keyframes fadeIn { to { opacity: 1; } }
        .n24-capsule {
            background: #fff; border: 1px solid #e8e8e8; border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08); overflow: hidden;
        }
        .n24-row { display: flex; align-items: center; padding: 10px 15px; gap: 15px; height: 48px; }
        .n24-btn { 
            background: #17469E; border: none; border-radius: 50%; width: 36px; height: 36px;
            color: #fff; cursor: pointer; display: flex; align-items: center; justify-content: center;
        }
        .n24-text-area { flex: 1; overflow: hidden; display: flex; flex-direction: column; justify-content: center; }
        .n24-marquee { font-size: 14px; font-weight: 700; color: #1C1C22; white-space: nowrap; }
        .n24-sub { font-size: 10px; color: #606060; font-weight: 500; }
        .n24-speed { 
            background: #F4F6F9; border: 1px solid #D1D5DB; border-radius: 6px; 
            padding: 4px 10px; font-size: 11px; font-weight: 700; color: #17469E; cursor: pointer; 
        }
        .n24-progress { width: 100%; height: 4px; background: #F0F2F5; }
        .n24-fill { width: 0%; height: 100%; background: #E6AB21; transition: width 0.3s linear; }
        .marquee-anim { animation: scrollText 12s linear infinite; display: inline-block; padding-left: 100%; }
        @keyframes scrollText { 0% { transform: translate(0, 0); } 100% { transform: translate(-100%, 0); } }
    `;
    const styleEl = document.createElement('style');
    styleEl.innerHTML = styleCSS;
    document.head.appendChild(styleEl);

    // 4. INJECT HTML UI
    const widgetHTML = `
        <div id="n24-audio-wrapper">
            <div class="n24-capsule">
                <div class="n24-row">
                    <button id="n24-play" class="n24-btn">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><path d="M8 5v14l11-7z"/></svg>
                    </button>
                    <div class="n24-text-area">
                        <div id="n24-title" class="n24-marquee">खबर सुनें</div>
                        <div id="n24-status" class="n24-sub">News24 AI Narrator</div>
                    </div>
                    <button id="n24-speed" class="n24-speed">1.0x</button>
                </div>
                <div class="n24-progress"><div id="n24-bar" class="n24-fill"></div></div>
            </div>
        </div>
    `;

    // Find where to insert (Before the article body)
    const targetEl = document.querySelector(TARGET_SELECTOR);
    if (!targetEl) { console.error("News24 Widget: Target not found"); return; }
    
    const wrapper = document.createElement('div');
    wrapper.innerHTML = widgetHTML;
    targetEl.parentNode.insertBefore(wrapper.firstElementChild, targetEl);

    // 5. THE LOGIC ENGINE (Minified Logic)
    let synth = window.speechSynthesis;
    let sentences = [], idx = 0, isPlaying = false, isPaused = false, rate = 1.0;
    let wDog = null;

    function init() {
        document.getElementById('n24-play').onclick = toggle;
        document.getElementById('n24-speed').onclick = speed;
        setupSticky();
    }

    function setupSticky() {
        const w = document.getElementById('n24-audio-wrapper');
        const headers = ['header', '.navbar', '#header', '.sticky-nav'];
        let offset = 0;
        headers.forEach(h => {
            let el = document.querySelector(h);
            if(el && getComputedStyle(el).position === 'fixed') offset = el.offsetHeight;
        });
        w.style.top = offset + 'px';
    }

    function sanitize() {
        let c = targetEl.cloneNode(true);
        ['h1','h2','script','style','button'].forEach(t=>c.querySelectorAll(t).forEach(e=>e.remove()));
        let txt = c.innerText.replace(/\s+/g,' ').trim();
        return txt.match(/[^.!?।]+[.!?।]+/g) || [txt];
    }

    function toggle() {
        if(isPlaying && !isPaused) { pause(); }
        else if(isPlaying && isPaused) { resume(); }
        else { play(); }
    }

    function play() {
        synth.cancel(); clearInterval(wDog);
        sentences = sanitize(); idx = 0; isPlaying = true; isPaused = false;
        speak();
        updUI(true);
    }

    function speak() {
        if(idx >= sentences.length) { reset(); return; }
        const u = new SpeechSynthesisUtterance(sentences[idx]);
        u.lang = WIDGET_LANG; u.rate = rate;
        u.onstart = () => { updStatus(WIDGET_LANG==='hi-IN'?"पढ़ रहा है...":"Reading..."); updBar(); kick(); };
        u.onend = () => { if(isPlaying && !isPaused) { idx++; setTimeout(speak, 80); } };
        u.onerror = () => { if(isPlaying) { idx++; speak(); } };
        synth.speak(u);
    }

    function pause() { synth.pause(); isPaused = true; updStatus("Paused"); updUI(false); }
    function resume() { if(synth.paused) synth.resume(); else speak(); isPaused = false; updUI(true); }
    function speed() { 
        synth.cancel(); rate = rate===1?1.25:(rate===1.25?1.5:1); 
        document.getElementById('n24-speed').innerText = rate + "x";
        if(isPlaying && !isPaused) speak();
    }
    
    function kick() { clearInterval(wDog); wDog = setInterval(() => { 
        if(isPlaying && !isPaused && !synth.speaking) { synth.cancel(); speak(); } 
    }, 4000); }

    function reset() { isPlaying=false; isPaused=false; synth.cancel(); updUI(false); updBar(0); updStatus("News24 AI"); }
    
    function updUI(active) {
        document.getElementById('n24-play').innerHTML = active ? 
            '<svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/></svg>' : 
            '<svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><path d="M8 5v14l11-7z"/></svg>';
    }
    function updStatus(t) { document.getElementById('n24-status').innerText = t; }
    function updBar(v) { 
        const p = v !== undefined ? v : ((idx+1)/sentences.length)*100;
        document.getElementById('n24-bar').style.width = p + "%"; 
    }

    // Auto-Run
    if(document.readyState === 'loading') window.addEventListener('DOMContentLoaded', init);
    else init();

})();
